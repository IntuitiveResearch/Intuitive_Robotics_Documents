<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Flipbook Viewer</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --panel: #111827cc;   /* gray-900/80 */
      --text: #e5e7eb;      /* gray-200 */
      --accent: #6366f1;    /* indigo-500 */
      --accent-2: #22c55e;  /* green-500 */
      --border: #1f2937;    /* gray-800 */
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, #0b1020 0%, #0f172a 60%, #0b1020 100%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .bar {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: blur(10px);
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
      padding: 10px 14px;
    }
    .brand {
      display: inline-flex; align-items: center; gap: 10px;
      font-weight: 700; letter-spacing: 0.3px;
    }
    .badge { font-size: 12px; padding: 2px 6px; border: 1px solid var(--border); border-radius: 999px; opacity: .9; }
    .title { margin: 0; font-size: 16px; font-weight: 600; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .btn {
      appearance: none; border: 1px solid var(--border);
      background: #0b1225; color: var(--text);
      padding: 8px 12px; font-weight: 600; border-radius: 8px;
      text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
      transition: transform .08s ease, border-color .2s ease;
      cursor: pointer;
    }
    .btn:hover { border-color: #334155; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--accent); border-color: #4f46e5; }
    .btn-primary:hover { border-color: #4338ca; }
    .btn-success { background: var(--accent-2); border-color: #16a34a; }
    .wrap { height: calc(100% - 56px); }
    iframe {
      width: 100%; height: 100%; border: 0; background: #000;
      border-top: 1px solid var(--border);
    }
    .note { padding: 16px; color: #cbd5e1; }
    .hidden { display: none; }
    @media (max-width: 640px) {
      .title { display: none; }
    }
  </style>
</head>
<body>
  <div class="bar">
    <div class="brand">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M4 12a8 8 0 1 0 16 0A8 8 0 0 0 4 12Zm6.5-3.5 5 3-5 3v-6Z" fill="currentColor" opacity=".9"/>
      </svg>
      <span>Flipbook</span>
      <span class="badge">PDF</span>
    </div>
    <h1 id="title" class="title">Viewer</h1>
    <a id="download" class="btn btn-success" href="#" download>
      <!-- download icon -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 3v10m0 0 4-4m-4 4-4-4M5 21h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Download PDF
    </a>
    <a id="openRaw" class="btn" href="#" target="_blank" rel="noopener">Open Raw</a>
  </div>

  <div class="wrap">
    <iframe id="viewer" title="PDF Flipbook Viewer"></iframe>
    <div id="msg" class="note hidden"></div>
  </div>

  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      const pdf   = qs.get("pdf");     // required
      const title = qs.get("title") || "Flipbook Viewer";

      // CDN viewer (no local files required)
      const VIEWER = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/web/viewer.html";
      // If your network blocks jsDelivr, change to:
      // const VIEWER = "https://unpkg.com/pdfjs-dist@4.4.168/web/viewer.html";

      const el = {
        iframe:   document.getElementById("viewer"),
        title:    document.getElementById("title"),
        download: document.getElementById("download"),
        openRaw:  document.getElementById("openRaw"),
        msg:      document.getElementById("msg")
      };

      document.title = title + " • Flipbook";
      el.title.textContent = title;

      if (!pdf) {
        el.msg.classList.remove("hidden");
        el.msg.innerHTML = "No PDF specified.<br/>Usage: <code>/flipbook.html?pdf=/files/ai-robotics-lab/brochures/robotics_lab_brochure.pdf&title=Robotics%20Lab%20Brochure</code>";
        return;
      }

      // Wire links
      el.download.href = pdf;
      el.openRaw.href  = pdf;

      // Load PDF.js viewer with file param
      const viewerUrl = VIEWER + "#file=" + encodeURIComponent(pdf);
      el.iframe.src = viewerUrl;

      // Fallback if the CDN viewer fails or is blocked
      let fallbackArmed = true;
      el.iframe.addEventListener("error", () => {
        if (!fallbackArmed) return;
        fallbackArmed = false;
        el.iframe.src = pdf; // Browser-native PDF viewer
        el.msg.classList.remove("hidden");
        el.msg.textContent = "Loaded with browser viewer (CDN viewer unavailable).";
      }, { once: true });

      // Also fallback if the viewer doesn’t load within 6 seconds
      const t = setTimeout(() => {
        try {
          // If contentWindow still about:blank (some CSPs), fallback
          const aboutBlank = !el.iframe.contentWindow || el.iframe.contentWindow.location.href === "about:blank";
          if (aboutBlank && fallbackArmed) {
            fallbackArmed = false;
            el.iframe.src = pdf;
            el.msg.classList.remove("hidden");
            el.msg.textContent = "Loaded with browser viewer (CDN viewer timed out).";
          }
        } catch (_) {
          // Cross-origin access throws; assume loaded or fallback separately
        }
      }, 6000);

      window.addEventListener("beforeunload", () => clearTimeout(t));
    })();
  </script>
</body>
</html>
